name: Deploy Lambdas on main (code-only, .lambdaignore, per-function via git diff + copy aws_platform_manager → platform_manager)

on:
  push:
    branches: [ main ]
    paths:
      - "src/calendar_agent/**"
      - "src/calendar_agent_api/**"
      - "src/calendar_mcp/**"
      - "src/calendar_oauth_redirect/**"
      - "src/calendar_shared/**"
      - ".github/workflows/deploy-on-main.yml"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect which Lambdas changed
    runs-on: ubuntu-latest
    outputs:
      agent:          ${{ steps.set.outputs.agent }}
      agent_api:      ${{ steps.set.outputs.agent_api }}
      mcp:            ${{ steps.set.outputs.mcp }}
      oauth_redirect: ${{ steps.set.outputs.oauth_redirect }}
      changed_files:  ${{ steps.set.outputs.changed_files }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need history for git diff

      - name: Compute changed files
        id: set
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"

          # Handle new branch / first push
          if [[ -z "${BEFORE}" || "${BEFORE}" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE="$(git rev-list -n 2 HEAD | tail -1)"
          fi

          # Files changed in this push
          CHANGED="$(git diff --name-only "${BEFORE}" "${SHA}" || true)"
          echo "Changed files:"
          echo "${CHANGED}"

          # Exclude patterns (markdown, config, ignore files)
          EXCLUDE='(\.md$|(^|/)README\.md$|(^|/)\.gitignore$|(^|/)\.ruffignore$|(^|/)\.mypyignore$|(^|/)\.mypy\.toml$|(^|/)\.ruff\.toml$|(^|/)\.lambdaignore$|(^|/)requirements\.txt$|(^|/)pyproject\.toml$)'

          EXCL_AGENT='(^|/)src/calendar_agent/agent_config\.json$'
          EXCL_AGENT_API='(^|/)src/calendar_agent_api/agent_api_config\.json$|(^|/)(fast_api_server\.py|fast_api_server/)'
          EXCL_MCP='(^|/)src/calendar_mcp/mcp_config\.json$'
          EXCL_OAUTH='(^|/)src/calendar_oauth_redirect/redirect_config\.json$'

          changed_in() {
            local PATH_PREFIX="$1"
            local EXTRA_EXCL="$2"
            echo "${CHANGED}" | grep -E "^${PATH_PREFIX}/" | grep -Ev "${EXCLUDE}|${EXTRA_EXCL}" >/dev/null
          }

          AGENT=false
          AGENT_API=false
          MCP=false
          OAUTH=false

          changed_in "src/calendar_agent" "${EXCL_AGENT}" && AGENT=true
          changed_in "src/calendar_agent_api" "${EXCL_AGENT_API}" && AGENT_API=true
          changed_in "src/calendar_mcp" "${EXCL_MCP}" && MCP=true
          changed_in "src/calendar_oauth_redirect" "${EXCL_OAUTH}" && OAUTH=true

          # If shared code changed, rebuild all lambdas
          if echo "${CHANGED}" | grep -E "^src/calendar_shared/" >/dev/null; then
            AGENT=true
            AGENT_API=true
            MCP=true
            OAUTH=true
          fi

          echo "agent=${AGENT}" >> "$GITHUB_OUTPUT"
          echo "agent_api=${AGENT_API}" >> "$GITHUB_OUTPUT"
          echo "mcp=${MCP}" >> "$GITHUB_OUTPUT"
          echo "oauth_redirect=${OAUTH}" >> "$GITHUB_OUTPUT"

          # Single-line JSON for debug (avoid multiline outputs)
          CHANGED_JSON=$(printf '%s\n' "${CHANGED}" | jq -R -s -c 'split("\n") - [""]')
          printf 'changed_files=%s\n' "${CHANGED_JSON}" >> "$GITHUB_OUTPUT"

      - name: Debug summary
        run: |
          echo "agent=${{ steps.set.outputs.agent }}"
          echo "agent_api=${{ steps.set.outputs.agent_api }}"
          echo "mcp=${{ steps.set.outputs.mcp }}"
          echo "oauth_redirect=${{ steps.set.outputs.oauth_redirect }}"
          echo "Changed files JSON: ${{ steps.set.outputs.changed_files }}"

  deploy_agent:
    name: Deploy calendar_agent
    needs: detect
    if: needs.detect.outputs.agent == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Stage, copy shared files into shared_infrastructure, zip (.lambdaignore)
        working-directory: src/calendar_agent
        shell: bash
        run: |
          set -euo pipefail

          STAGE="$(mktemp -d)"
          rsync -a ./ "$STAGE"/

          # Copy the shared files into shared_infrastructure/
          mkdir -p "$STAGE/shared_infrastructure"
          rm -f "$STAGE/shared_infrastructure/platform_manager.py"
          rm -f "$STAGE/shared_infrastructure/redis_manager.py"
          rm -f "$STAGE/shared_infrastructure/hmac_auth.py"
          cp "${{ github.workspace }}/src/calendar_shared/aws_platform_manager.py" \
              "$STAGE/shared_infrastructure/platform_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/redis_manager.py" \
              "$STAGE/shared_infrastructure/redis_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/hmac_auth.py" \
              "$STAGE/shared_infrastructure/hmac_auth.py"
          echo "Injected shared files → shared_infrastructure/ (platform_manager, redis_manager, hmac_auth)"

          # Build zip excludes from .lambdaignore + baseline
          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")

          OUT_ZIP="${{ github.workspace }}/package-calendar_agent.zip"
          rm -f "$OUT_ZIP"
          (cd "$STAGE" && zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}")

      - name: Update Lambda code
        run: |
          aws lambda update-function-code --function-name "calendar_agent" \
            --zip-file "fileb://${{ github.workspace }}/package-calendar_agent.zip" \
            --publish --output json >/dev/null
          echo "Updated calendar_agent"

  deploy_agent_api:
    name: Deploy calendar_agent_api
    needs: detect
    if: needs.detect.outputs.agent_api == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Stage, copy shared files into shared_infrastructure, zip (.lambdaignore)
        working-directory: src/calendar_agent_api
        shell: bash
        run: |
          set -euo pipefail

          STAGE="$(mktemp -d)"
          rsync -a ./ "$STAGE"/

          # Copy the shared files into shared_infrastructure/
          mkdir -p "$STAGE/shared_infrastructure"
          rm -f "$STAGE/shared_infrastructure/platform_manager.py"
          rm -f "$STAGE/shared_infrastructure/redis_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/aws_platform_manager.py" \
              "$STAGE/shared_infrastructure/platform_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/redis_manager.py" \
              "$STAGE/shared_infrastructure/redis_manager.py"
          echo "Injected shared files → shared_infrastructure/ (platform_manager, redis_manager)"

          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")

          OUT_ZIP="${{ github.workspace }}/package-calendar_agent_api.zip"
          rm -f "$OUT_ZIP"
          (cd "$STAGE" && zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}")

      - name: Update Lambda code
        run: |
          aws lambda update-function-code --function-name "calendar_agent_api" \
            --zip-file "fileb://${{ github.workspace }}/package-calendar_agent_api.zip" \
            --publish --output json >/dev/null
          echo "Updated calendar_agent_api"

  deploy_mcp:
    name: Deploy calendar_mcp
    needs: detect
    if: needs.detect.outputs.mcp == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Stage, copy shared files into shared_infrastructure, zip (.lambdaignore)
        working-directory: src/calendar_mcp
        shell: bash
        run: |
          set -euo pipefail

          STAGE="$(mktemp -d)"
          rsync -a ./ "$STAGE"/

          # Copy the shared files into shared_infrastructure/
          mkdir -p "$STAGE/shared_infrastructure"
          rm -f "$STAGE/shared_infrastructure/platform_manager.py"
          rm -f "$STAGE/shared_infrastructure/redis_manager.py"
          rm -f "$STAGE/shared_infrastructure/hmac_auth.py"
          rm -f "$STAGE/shared_infrastructure/cryptography_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/aws_platform_manager.py" \
              "$STAGE/shared_infrastructure/platform_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/redis_manager.py" \
              "$STAGE/shared_infrastructure/redis_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/hmac_auth.py" \
              "$STAGE/shared_infrastructure/hmac_auth.py"
          cp "${{ github.workspace }}/src/calendar_shared/cryptography_manager.py" \
              "$STAGE/shared_infrastructure/cryptography_manager.py"
          echo "Injected shared files → shared_infrastructure/ (platform_manager, redis_manager, hmac_auth, cryptography_manager)"

          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")

          OUT_ZIP="${{ github.workspace }}/package-calendar_mcp.zip"
          rm -f "$OUT_ZIP"
          (cd "$STAGE" && zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}")

      - name: Update Lambda code
        run: |
          aws lambda update-function-code --function-name "calendar_mcp" \
            --zip-file "fileb://${{ github.workspace }}/package-calendar_mcp.zip" \
            --publish --output json >/dev/null
          echo "Updated calendar_mcp"

  deploy_oauth_redirect:
    name: Deploy calendar_oauth_redirect
    needs: detect
    if: needs.detect.outputs.oauth_redirect == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Stage, copy shared files into shared_infrastructure, zip (.lambdaignore)
        working-directory: src/calendar_oauth_redirect
        shell: bash
        run: |
          set -euo pipefail

          STAGE="$(mktemp -d)"
          rsync -a ./ "$STAGE"/

          # Remove any dangling links
          rm -f "$STAGE/shared_infrastructure/platform_manager.py"
          rm -f "$STAGE/shared_infrastructure/redis_manager.py"
          rm -f "$STAGE/shared_infrastructure/cryptography_manager.py"

          # Copy the shared files into shared_infrastructure/
          mkdir -p "$STAGE/shared_infrastructure"
          cp "${{ github.workspace }}/src/calendar_shared/aws_platform_manager.py" \
              "$STAGE/shared_infrastructure/platform_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/redis_manager.py" \
              "$STAGE/shared_infrastructure/redis_manager.py"
          cp "${{ github.workspace }}/src/calendar_shared/cryptography_manager.py" \
              "$STAGE/shared_infrastructure/cryptography_manager.py"
          echo "Injected shared files → shared_infrastructure/ (platform_manager, redis_manager, cryptography_manager)"

          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")

          OUT_ZIP="${{ github.workspace }}/package-calendar_oauth_redirect.zip"
          rm -f "$OUT_ZIP"
          (cd "$STAGE" && zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}")

      - name: Update Lambda code
        run: |
          aws lambda update-function-code --function-name "calendar_oauth_redirect" \
            --zip-file "fileb://${{ github.workspace }}/package-calendar_oauth_redirect.zip" \
            --publish --output json >/dev/null
          echo "Updated calendar_oauth_redirect"
