name: Deploy Lambdas on main (code-only, .lambdaignore)

on:
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - ".github/workflows/deploy-on-main.yml"
    paths-ignore:
      # ignore specific config files
      - "src/calendar_agent/agent_config.json"
      - "src/calendar_agent_api/agent_api_config.json"
      - "src/calendar_mcp/mcp_config.json"
      - "src/calendar_oauth_redirect/redirect_config.json"
      # ignore any non-code files anywhere
      - "**/.gitignore"
      - "**/.ruffignore"
      - "**/.mypyignore"
      - "**/.mypy.toml"
      - "**/.ruff.toml"
      - "**/.lambdaignore"
      - "**/requirements.txt"
      - "**/pyproject.toml"
      - "**/README.md"
      - "**/CERTIFICATES_README.md"
      - "**/INSTALL_README.md"
      - "**/fast_api_server.py"
      - "**/fast_api_server/**"

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1

    strategy:
      fail-fast: false
      matrix:
        lambda:
          - { path: "src/calendar_agent",             name: "calendar_agent" }
          - { path: "src/calendar_agent_api",         name: "calendar_agent_api" }
          - { path: "src/calendar_mcp",               name: "calendar_mcp" }
          - { path: "src/calendar_oauth_redirect",    name: "calendar_oauth_redirect" }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Zip code using .lambdaignore (no deps; using Layers)
        working-directory: ${{ matrix.lambda.path }}
        shell: bash
        run: |
          set -euo pipefail

          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"
              line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi

          # Portable baseline excludes for zip
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")

          OUT_ZIP="${{ github.workspace }}/package-${{ matrix.lambda.name }}.zip"
          rm -f "$OUT_ZIP"
          zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}"
          echo "Created $(basename "$OUT_ZIP")"

      - name: Update Lambda code
        shell: bash
        run: |
          ZIP="${{ github.workspace }}/package-${{ matrix.lambda.name }}.zip"
          aws lambda update-function-code \
            --function-name "${{ matrix.lambda.name }}" \
            --zip-file "fileb://${ZIP}" \
            --publish \
            --output json >/dev/null
          echo "Updated ${{ matrix.lambda.name }}"
