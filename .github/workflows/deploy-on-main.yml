name: Deploy Lambdas on main (code-only, .lambdaignore, per-function deploy)

on:
  push:
    branches: [ main ]
    paths:
      - "src/calendar_agent/**"
      - "src/calendar_agent_api/**"
      - "src/calendar_mcp/**"
      - "src/calendar_oauth_redirect/**"
      - ".github/workflows/deploy-on-main.yml"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changed Lambda folders
    runs-on: ubuntu-latest
    outputs:
      agent:         ${{ steps.filter.outputs.agent }}
      agent_api:     ${{ steps.filter.outputs.agent_api }}
      mcp:           ${{ steps.filter.outputs.mcp }}
      oauth_redirect: ${{ steps.filter.outputs.oauth_redirect }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensure proper diff

      - name: Filter changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            agent:
              - 'src/calendar_agent/**'
              - '!**/*.md'
              - '!**/.gitignore'
              - '!**/.ruffignore'
              - '!**/.mypyignore'
              - '!**/.mypy.toml'
              - '!**/.ruff.toml'
              - '!**/.lambdaignore'
              - '!**/requirements.txt'
              - '!**/pyproject.toml'
              - '!src/calendar_agent/agent_config.json'

            agent_api:
              - 'src/calendar_agent_api/**'
              - '!**/*.md'
              - '!**/.gitignore'
              - '!**/.ruffignore'
              - '!**/.mypyignore'
              - '!**/.mypy.toml'
              - '!**/.ruff.toml'
              - '!**/.lambdaignore'
              - '!**/requirements.txt'
              - '!**/pyproject.toml'
              - '!src/calendar_agent_api/agent_api_config.json'
              - '!**/fast_api_server.py'
              - '!**/fast_api_server/**'

            mcp:
              - 'src/calendar_mcp/**'
              - '!**/*.md'
              - '!**/.gitignore'
              - '!**/.ruffignore'
              - '!**/.mypyignore'
              - '!**/.mypy.toml'
              - '!**/.ruff.toml'
              - '!**/.lambdaignore'
              - '!**/requirements.txt'
              - '!**/pyproject.toml'
              - '!src/calendar_mcp/mcp_config.json'

            oauth_redirect:
              - 'src/calendar_oauth_redirect/**'
              - '!**/*.md'
              - '!**/.gitignore'
              - '!**/.ruffignore'
              - '!**/.mypyignore'
              - '!**/.mypy.toml'
              - '!**/.ruff.toml'
              - '!**/.lambdaignore'
              - '!**/requirements.txt'
              - '!**/pyproject.toml'
              - '!src/calendar_oauth_redirect/redirect_config.json'

      - name: Debug which deploys will run
        run: |
          echo "agent=${{ steps.filter.outputs.agent }}"
          echo "agent_api=${{ steps.filter.outputs.agent_api }}"
          echo "mcp=${{ steps.filter.outputs.mcp }}"
          echo "oauth_redirect=${{ steps.filter.outputs.oauth_redirect }}"

  deploy_agent:
    name: Deploy calendar_agent
    needs: changes
    if: needs.changes.outputs.agent == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Zip code using .lambdaignore
        working-directory: src/calendar_agent
        shell: bash
        run: |
          set -euo pipefail
          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")
          OUT_ZIP="${{ github.workspace }}/package-calendar_agent.zip"
          rm -f "$OUT_ZIP"
          zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}"

      - name: Update Lambda code
        run: |
          ZIP="${{ github.workspace }}/package-calendar_agent.zip"
          aws lambda update-function-code \
            --function-name "calendar_agent" \
            --zip-file "fileb://${ZIP}" \
            --publish \
            --output json >/dev/null
          echo "Updated calendar_agent"

  deploy_agent_api:
    name: Deploy calendar_agent_api
    needs: changes
    if: needs.changes.outputs.agent_api == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Zip code using .lambdaignore
        working-directory: src/calendar_agent_api
        shell: bash
        run: |
          set -euo pipefail
          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")
          OUT_ZIP="${{ github.workspace }}/package-calendar_agent_api.zip"
          rm -f "$OUT_ZIP"
          zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}"

      - name: Update Lambda code
        run: |
          ZIP="${{ github.workspace }}/package-calendar_agent_api.zip"
          aws lambda update-function-code \
            --function-name "calendar_agent_api" \
            --zip-file "fileb://${ZIP}" \
            --publish \
            --output json >/dev/null
          echo "Updated calendar_agent_api"

  deploy_mcp:
    name: Deploy calendar_mcp
    needs: changes
    if: needs.changes.outputs.mcp == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Zip code using .lambdaignore
        working-directory: src/calendar_mcp
        shell: bash
        run: |
          set -euo pipefail
          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")
          OUT_ZIP="${{ github.workspace }}/package-calendar_mcp.zip"
          rm -f "$OUT_ZIP"
          zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}"

      - name: Update Lambda code
        run: |
          ZIP="${{ github.workspace }}/package-calendar_mcp.zip"
          aws lambda update-function-code \
            --function-name "calendar_mcp" \
            --zip-file "fileb://${ZIP}" \
            --publish \
            --output json >/dev/null
          echo "Updated calendar_mcp"

  deploy_oauth_redirect:
    name: Deploy calendar_oauth_redirect
    needs: changes
    if: needs.changes.outputs.oauth_redirect == 'true'
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Zip code using .lambdaignore
        working-directory: src/calendar_oauth_redirect
        shell: bash
        run: |
          set -euo pipefail
          EXCLUDES=()
          if [ -f .lambdaignore ]; then
            while IFS= read -r line || [ -n "$line" ]; do
              line="${line#"${line%%[![:space:]]*}"}"; line="${line%"${line##*[![:space:]]}"}"
              [ -z "$line" ] && continue
              [[ "$line" =~ ^# ]] && continue
              EXCLUDES+=(-x "$line")
            done < .lambdaignore
          fi
          EXCLUDES+=(-x "*/__pycache__/*" -x "*.pyc" -x ".DS_Store" -x ".git/**")
          OUT_ZIP="${{ github.workspace }}/package-calendar_oauth_redirect.zip"
          rm -f "$OUT_ZIP"
          zip -r9 "$OUT_ZIP" . "${EXCLUDES[@]}"

      - name: Update Lambda code
        run: |
          ZIP="${{ github.workspace }}/package-calendar_oauth_redirect.zip"
          aws lambda update-function-code \
            --function-name "calendar_oauth_redirect" \
            --zip-file "fileb://${ZIP}" \
            --publish \
            --output json >/dev/null
          echo "Updated calendar_oauth_redirect"
